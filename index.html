<html>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
        }

        #chartdiv {
            width: 100%;
            height: 90%;
        }
        .YearDisplayer{
            font-size: 200%;
            font-weight: bold;
            display:flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            padding-left: 25px;
            padding-right: 25px;

        }
        .PopulationLeyend{
            display:flex;
            font-size: 200%;
            font-weight: bold;
            align-items: center;
            justify-content: center;
            height: 100%;
            padding-left: 25px;
            padding-right: 25px;

        }
        #Leyend {
            position: absolute;
            bottom: 5%;
            left: 35%;
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin:10px;
            background-color:rgba(0,0,0,0.3);
            padding:10px;
            width:30%;
            
        }
        #Title{
            height: 10%;
            width: 100%;
            top: 0%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 200%;
            font-weight: bold;

        }
        #Title2{
            height: 10%;
            width: 100%;
            top: 0%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 200%;
            font-weight: bold;
            position: absolute;
            top:20px;

        }
        .bigCircle {
            height: 60px;
            width: 60px;
            background-color: rgba(0,0,255,0.3);
            border-radius: 50%;
            display: inline-block;
            display:flex;
            align-items: center;
            justify-content: center;
        }
        #Tutorial {
            position: absolute;
            bottom: 0%;
            left: 0%;
            display: flex;
            flex-flow: column wrap;
            align-items: center;
            justify-content: space-around;
            margin:0;
            background-color:rgba(255,255,255,1);
            width:100%;
            height:100%;
            z-index: 10000;
        }
        #Tutorial > div{
            display:flex;
            flex-flow: column wrap;
            align-items: center;
            justify-content: space-around;
        }
        #Tutorial > div > span{
            font-size: 130%;
            font-weight: bold;
        }
        #Tutorial > div > a{
            font-size: 130%;
            font-weight: bold;
        }

        .hidden{
            display: none!important;
        }
        .button{
            background-color: rgba(200,200,200,0.7);
            border-radius: 10px;
            border: 1px solid black;
            padding: 5px;
            position:fixed;
            bottom:30px
        }
        .button:hover {
            background-color: rgba(230,230, 230,0.7);
            cursor: pointer;
        }
        #gradient{
            background: linear-gradient(90deg, rgba(0,255,0,1) 0%, rgba(255,0,0,1) 100%);
            width: 80%;
            min-height: 20px;
            min-width: 892px;
            margin-left: 20px;
            margin-right: 20px;
        }

    </style>
    <head>
        <!-- <script src="https://cdn.plot.ly/plotly-2.12.1.min.js"></script>
        <script src="https://cdn.amcharts.com/lib/5/index.js"></script>
        <script src="https://cdn.amcharts.com/lib/5/xy.js"></script>
        <script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>
        <script src="https://cdn.amcharts.com/lib/5/locales/de_DE.js"></script>
        <script src="https://cdn.amcharts.com/lib/5/geodata/germanyLow.js"></script>
        <script src="https://cdn.amcharts.com/lib/5/fonts/notosans-sc.js"></script> -->
        <link href="https://cdn.lineicons.com/3.0/lineicons.css" rel="stylesheet">
        <script src="https://cdn.amcharts.com/lib/5/index.js"></script>
        <script src="https://cdn.amcharts.com/lib/5/map.js"></script>
        <script src="https://cdn.amcharts.com/lib/5/geodata/worldLow.js"></script>
        <script src="https://cdn.amcharts.com/lib/5/geodata/continentsLow.js"></script>
        <script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>
        <script src="data.js"></script>

        
    </head>
    <body id="body">
        <div id="Title">Human population vs Known animal extinctions from 2150 BC to 1975 AD</div>
        <div id="chartdiv"></div>
        <div id="Tutorial">
            <div id="Title2">Human population vs Known animal extinctions from 2150 BC to 1975 AD</div>
            <div id="Step1">
                <span>Use right and left arrow keys or "a" and "d" to move forward and backward in time</span>
                <span>Use space bar to start/stop automatic forward</span>
                <div id="KeyboardDisplay">
                    <img id="Keyboard" src="key_over.png" align="middle">
                </div>
            </div>
            <div id="Step2" class="hidden">
                <span>Population is shown as circles. Circle size relation with population number is shown on the bottom of the page</span>
                <div style="margin-top:10px;">
                    <div class="PopulationLeyend"><span class="bigCircle">
                        <i class="lni lni-user"></i></span>
                        <div>10m</div>
                    </div>
                </div>
                <span style="margin-top:10px;">Mouse pointer can be placed over population circles to display city name and population value</span>
            </div>
            <div id="Step3" class="hidden">
                <span>
                    Year beign visualized is shown on the bottom of the page.
                </span>
                <div style="margin-top:10px;">
                    <div class="YearDisplayer">
                        <i class="lni lni-timer"></i>
                        <div>2150 BC</div>
                    </div>
                </div>
            </div>
            <div id="Step4" class="hidden">
                <span>The quantity of extinctions will be displayed by continent with color. Green means low extinctions, red means lot of animal extinctions</span>
                <div style="display: flex;flex-flow: row nowrap;justify-content: space-between;align-items: center;margin-top: 40px;width: 1000 px;">
                    0 Extictions<div id="gradient"></div>180 Extictions
                </div>
                <span style="margin-top:10px;">Mouse pointer can be placed over continents to display number of extincted species</span>
            </div>
            <div id="Step5" class="hidden">
                <span>Map can be mooved and zoomed. You can change from plane to globe with the button in the top left corner</span>
                <div id="KeyboardDisplay">
                    <img id="Keyboard" src="button_globe.png" align="middle">
                </div>
            </div>
            <div id="Step6" class="hidden">
                <span>Sources:</span>
                <a href="https://www.kaggle.com/datasets/junyaozhang/extinct-animals-database">Extinct Animals Dataset</a>
                <a href="https://figshare.com/articles/dataset/Chandler_Population_Data/2059494">Human Population Dataset</a>
            </div>
            <a class="button"  onclick="nextStepTutorial()">CONTINUE</a>
        </div>

        <div id="FullScreen">
            <div id="Leyend">
                <div id="YearDisplayer" class="YearDisplayer">
                    <i class="lni lni-timer"></i>
                    <div id="YearText">YEAR: </div>
                </div>
                <div id="PopulationLeyend" class="PopulationLeyend"><span class="bigCircle">
                    <i class="lni lni-user"></i></span>
                    <div id="PopulationText"> </div>
                </div>
            </div>
        </div>
    </body>
    <script>
        /* TO DO:
            -Save structuredData in data.js so it must not calculate every initialitation

            
            -Ajustar la escala para que el paso entre años sea siempre el mismo. Tenemos 798 años, tenemos que calcular
            la máxima diferencia y la mínima diferencia entre dos saltos y, hecho esto calcular el salto de años para que 
            al pulsar la tecla avance esos años y que sea unas 100 pulsaciones en total pasar todo el gráfico
            -Add countries color depending on animal extinction and year
            -Display legend with circle size in top right corner
            -Display timeline
            -Limitate zoom in and out
            -Intentar poder pasar a mano el radius
            -hay un bug si no pones modo globo y vuelves a pasar a mapa no deja subir el mapa arriba y abajo

        */
        // WORKING WITH POPULATION pop_data (IMPORTED FROM ./data.js)
        //Get a list of years apearing in population dataset
        availablePopYears = Object.getOwnPropertyNames(population).map(function(item) {
            return parseInt(item);
        }).sort(function(a, b) {
            return a - b;
        });
        
        //Calculando la escala tal cual he explicado en el TODO:
        var yearsScale = 1;
        var min_diference = 2000;
        var max_diference = 0;
        var min_year = Math.min(...availablePopYears)
        var max_year = Math.max(...availablePopYears)
        availablePopYears.forEach((year, idx) =>{
            var dif = availablePopYears[idx+1] - year 
            if( dif > max_diference){
                max_diference = dif;
            }
            if(dif < min_diference){
                min_diference = dif;
            }
        });

        //HAY QUE REPLANTEARSE LO DE LA ESCALA DE TIEMPO, DE MOMENTO LO DEJO ASÍ
        
        // Following is made to structure data by year with current population status.
        var getPopulation = function(year, return_max=false){
            // year: value of year.
            // returns: A list with population points as they were in given year
            
            //Get all years from data smaller than given value
            if(!availablePopYears.includes(year)){
                return (pop_data) // I know this is a shit but must finish fast
            }
            selectedYears = availablePopYears.filter(function(item){
                if (item <= year){
                    return(item)
                }
            })

            // We stored all points in selected points. As selected year is ordered from past to present if 
            // a location appears more than once it will be replaced for last aparition.
            // We store cities too so later we can easily iterate over selectedPoints.
            var selectedPoints = {}
            var cities = []
            var maxPop = 0;
            var maxPopCity = "";
            selectedYears.forEach(yearCounter => {
                // console.log(yearCounter);
                population[yearCounter].forEach(point => {
                    // console.log(point)
                    if (!cities.includes(point["city"])){
                        cities.push(point["city"])
                    }
                    selectedPoints[point["city"]] = {
                        ID:  point["city"],
                        longitude: point["longitude"],
                        latitude: point["latitude"],
                        title: point["city"],
                        population: point["population"]
                    }
                    maxPop = Math.max(point["population"], maxPop)
                    maxpopCity = maxPop==point["population"]? point["city"]:maxpopCity
                });
            });

            var result = [];
            cities.forEach(city => {
                result.push(selectedPoints[city])
            })
            
            //Ading an empty value with population 1 so heatrules adjust correctly
            result.push({
                longitude: NaN,
                latitude: NaN,
                title: "None",
                population: 1,
                value: 1,
            })
            
            if(return_max){
                return({res:result, max: maxPop, city: maxpopCity})
            }

            return(result)
        }
        let displayingYear = min_year;



        structuredPopulation = {}
        max_per_year = {}
        availablePopYears.forEach(year =>{
            result_max = getPopulation(year,true)
            structuredPopulation[year] = result_max.res
            max_per_year[year] = result_max.max 
        })

        console.log(max_per_year)

        var pop_data =structuredPopulation[displayingYear]

        var getPopYearsBefore = function(year){
            if(availablePopYears.includes(year)){
                return (year)
            }
            var result = availablePopYears[0]
            for(i = 0; i < availablePopYears.length; i++){
                if (availablePopYears[i] <= year){
                    if(availablePopYears[i] > result){
                        result = availablePopYears[i]
                    }
                }
                else{
                    break;
                }
            }
            return(result)
        }

        var getNextAvailableYear = function(year){
            for(i = 0; i < availablePopYears.length; i++){
                if(availablePopYears[i] > year){
                    return(availablePopYears[i])
                }
            }
            return(NaN)
        }

        // Calculo de string con todos los años para facilitar su impresión por consola
        // var stringyears = ""
        // availablePopYears.forEach(year => {stringyears = stringyears + year +", "})

        // Working with extinctions (data.js)
        availableExtYears = Object.getOwnPropertyNames(extinctions).map(function(item) {
            return parseInt(item);
        }).sort(function(a, b) {
            return a - b;
        });
        
        var componentToHex= c => {
            var hex = c.toString(16);
            return hex.length == 1 ? "0" + hex : hex;
        }

        function rgbToHex(r, g, b) {
            return "#" + componentToHex(r) + componentToHex(g) + componentToHex(b);
        }

        var get_extinction_color = function(max, min, value){
            value = value<1? 1:value
            var percent = ((value-min) / (max-min))             
            hex_color = "#" + componentToHex(parseInt(percent * 255)) + componentToHex(parseInt((1-percent) * 255)) + componentToHex(0);
            return(am5.color(hex_color))
        }

        var max_extinctions = 179 // Harcoded this value

        var get_extinction_data = function(year){
            result=[]
            for (const key in extinctions[year]){
                result.push({
                    id: key,
                    total_count: extinctions[year][key]["total_count"],
                    settings: {
                        fill: get_extinction_color(max_extinctions, 0, extinctions[year][key]["total_count"]),
                }
                })
            }
            return(result)
        }

        var getExtYearBefore = function(year){
            result = availableExtYears.filter( v => {if(v<=year) return(v)}).slice(-1)
            return(result)
        }


        var ext_data = get_extinction_data(getExtYearBefore(min_year))

        //Working with interface:
        var yearDisplayer = document.querySelector('#YearText');
        var displayYear = function(year){
            bc_ad = year < 0? " BC" : " AD";
            yearDisplayer.innerHTML = year + bc_ad;
        }

        var populationDisplayer = document.querySelector('#PopulationText');
        var displayPopulation = function(population){
            var magnitude =""
            res = population
            if ((population/1000000) > 1){
                res = parseInt(population / 1000000);
                magnitude = "m"
            }
            else if ((population/1000) > 1){
                res = parseInt(population / 1000);
                magnitude = "k"
            }
            populationDisplayer.innerHTML = res + magnitude
        }
        
        displayPopulation(98000)

        displayYear(min_year);
        var step_tutorial = 1;
        var nextStepTutorial = () => {
            if(step_tutorial == 1){
                document.querySelector('#Step1').classList.add('hidden')
                document.querySelector('#Step2').classList.remove('hidden')
                step_tutorial++;
                return
            }
            if(step_tutorial == 2){
                document.querySelector('#Step2').classList.add('hidden')
                document.querySelector('#Step3').classList.remove('hidden')
                step_tutorial++;
                return
            }
            if(step_tutorial == 3){
                document.querySelector('#Step3').classList.add('hidden')
                document.querySelector('#Step4').classList.remove('hidden')
                step_tutorial++;
                return
            }
            if(step_tutorial == 4){
                document.querySelector('#Step4').classList.add('hidden')                
                document.querySelector('#Step5').classList.remove('hidden')
                step_tutorial++;
                return
            }
            if(step_tutorial == 5){
                document.querySelector('#Step5').classList.add('hidden')
                document.querySelector('#Step6').classList.remove('hidden')
                step_tutorial++;
                return
            }
            if(step_tutorial == 6){
                document.querySelector('#Step6').classList.add('hidden')
                document.querySelector('#Tutorial').classList.add('hidden')
                step_tutorial++;
                return
            }
            return
        }

        // SETTING MAP 
        var chart; // Our chart obj
        var bubbleSeries;// Layer of bubles in the map (population)
        var polygonSeries; // Layer of continents in the map
        var addPoint; // Method to add points to the chart
        var clearPoints; //Method to clear all the points in the chart
        var setPoints; // Method to set all points in the map
        var setContinentsBackground;
        var original;
        //Previous variables will be set in following function
        am5.ready(function() {

            // Create root element
            // https://www.amcharts.com/docs/v5/getting-started/#Root_element
            var root = am5.Root.new("chartdiv");

            // Set themes
            // https://www.amcharts.com/docs/v5/concepts/themes/
            root.setThemes([
                am5themes_Animated.new(root)
            ]);

            // Create the map chart
            // https://www.amcharts.com/docs/v5/charts/map-chart/
            chart = root.container.children.push(
                am5map.MapChart.new(root, {
                    panX: "rotateX",
                    panY: "translateY",
                    // projection: am5map.geoNaturalEarth1(),
                    minZoomLevel: 1.5,
                    maxZoomLevel: 16,
                    // homeZoomLevel: 1.5,
                    // homeGeoPoint: { longitude: 10, latitude: 52 },
                    projection: am5map.geoMercator(),
                    layout: root.horizontalLayout
                })
            );

            // Add labels and controls
            var cont = chart.children.push(
            am5.Container.new(root, {
                layout: root.horizontalLayout,
                x: 20,
                y: 40
            })
            );

            
            cont.children.push(
                am5.Label.new(root, {
                    centerY: am5.p50,
                    text: "Map"
                })
            );

            var switchButton = cont.children.push(
                am5.Button.new(root, {
                    themeTags: ["switch"],
                    centerY: am5.p50,
                    icon: am5.Circle.new(root, {
                    themeTags: ["icon"]
                    })
                })
            );

            switchButton.on("active", function () {
                if (!switchButton.get("active")) {
                    chart.set("projection", am5map.geoMercator());
                    chart.set("panY", "translateY");
                    chart.set("rotationY", 0);
                    
                    backgroundSeries.mapPolygons.template.set("fillOpacity", 0);
                } else {
                    chart.set("projection", am5map.geoOrthographic());
                    chart.set("panY", "rotateY");
                    backgroundSeries.mapPolygons.template.set("fillOpacity", 0.1);
                }
            });

            cont.children.push(
                am5.Label.new(root, {
                    centerY: am5.p50,
                    text: "Globe"
                })
            );

            // Create series for background fill
            // https://www.amcharts.com/docs/v5/charts/map-chart/map-polygon-series/#Background_polygon
            var backgroundSeries = chart.series.push(am5map.MapPolygonSeries.new(root, {}));
            backgroundSeries.mapPolygons.template.setAll({
            fill: root.interfaceColors.get("alternativeBackground"),
            fillOpacity: 0,
            strokeOpacity: 0
            });

            // Add background polygon
            // https://www.amcharts.com/docs/v5/charts/map-chart/map-polygon-series/#Background_polygon
            backgroundSeries.data.push({
                geometry: am5map.getGeoRectangle(90, 180, -90, -180)
            });

            // Create main polygon series for countries
            // https://www.amcharts.com/docs/v5/charts/map-chart/map-polygon-series/
            polygonSeries = chart.series.push(
                am5map.MapPolygonSeries.new(root, {
                    geoJSON: am5geodata_continentsLow,
                    exclude: ["antarctica"]
                })
            );

            polygonSeries.mapPolygons.template.setAll({
                tooltipText: "{name}: {total_count}",
                interactive: true,
                templateField: "settings"
            });

            polygonSeries.mapPolygons.template.states.create("hover", {
                // fill: am5.color(0x677935),
                // stroke: am5.color(0x000000)
            });
            polygonSeries.mapPolygons.template.events.on("pointerover", function(ev) {
                console.log("Funciona")
                heatLegend.showValue(ev.target.dataItem.get("total_count"));
            });
            polygonSeries.data.setAll(ext_data)
            setContinentsBackground = function(continents){
                continents.forEach(con => {
                    var dataItem = polygonSeries.getDataItemById(con["id"]);
                    if (dataItem) {
                        dataItem.get("mapPolygon").set("fill", con["settings"]["fill"]);
                        dataItem.set("total_count", con["total_count"]);
                    }
                });
                
            }

            setContinentsBackground(ext_data)

            // setContinentsBackground(original)
            // console.log(original)

            // Create polygon series for circles
            // https://www.amcharts.com/docs/v5/charts/map-chart/map-polygon-series/
            
            var circleTemplate = am5.Template.new({
                
            });
            
            bubbleSeries = chart.series.push(
                am5map.MapPointSeries.new(root, {
                    calculateAggregates: true,
                    valueField: "population",
                    latitudeField: "latitude",
                    longitudeField: "longitude"
                })
            );
            
            bubbleSeries.bullets.push(function () {
                return am5.Bullet.new(root, {
                    sprite: am5.Circle.new(root, {
                        
                        fill: am5.color(0x0000ff),
                        fillOpacity: 0.3,
                        tooltipText: "{title}: {value}"
                    }, circleTemplate)
                });
            });
            
            bubbleSeries.set("heatRules", [{
                target: circleTemplate,
                min: 5,
                max: 30,
                key: "radius",
                dataField: "value"
            }]);
            
            setBubbles = function(cities){
                bubbleSeries.data.setAll(cities)
            }
            setBubbles(pop_data);

            //LEGEND
            var heatLegend = chart.children.push(am5.HeatLegend.new(root, {
                orientation: "vertical",
                startColor: am5.color(0x00ff00),
                endColor: am5.color(0xff0000),
                startText: "0 Extincted animals",
                endText: "180 Extincted animals",
                startValue: 0,
                endValue: 180
            }));

            heatLegend.startLabel.setAll({
                fontSize: 12,
                fill: heatLegend.get("startColor")
            });
            heatLegend.endLabel.setAll({
                fontSize: 12,
                fill: heatLegend.get("endColor")
            });

        // Make stuff animate on load
        console.log(chart)
        
        
        chart.appear(1000, 100);
        // chart.zoomIn(0.5)
        // chart.zoomToGeoBounds(
        //     { bottom: -10,
        //     left: -10,
        //     right: 10,
        //     top: 10 }
        // )

        
    }); // end am5.ready()

        
        forwardKeys = [39, 68] //right arrow, "D"
        backwardKeys = [37, 65] //left arrow, "A"
        let b = document.getElementById("body"); //making var for body
        var updateMap = () => {
            pop_data = structuredPopulation[getPopYearsBefore(displayingYear)]
            ext_data = get_extinction_data(getExtYearBefore(displayingYear))
            displayYear(displayingYear);
            displayPopulation(max_per_year[getPopYearsBefore(displayingYear)])
            setBubbles(pop_data)
            setContinentsBackground(ext_data)
        }
        
        //TODO: instead of growing by 10 always make it dependant of the time key is pressed.
        b.addEventListener("keydown", (evt) => {
            if(forwardKeys.includes(evt.keyCode)){
                displayingYear = Math.min(displayingYear + 10, max_year);
                if(displayingYear>=max_year) return;
            }
            else if(backwardKeys.includes(evt.keyCode)){
                displayingYear = Math.max(displayingYear - 10, min_year);           
                if(displayingYear<=min_year) return;
            }
            else if(evt.keyCode == 32){ //space bar
                autoplay = !autoplay
                console.log("Changed: " + autoplay)
                return
            }
            else{
                console.log(evt.keyCode)
                return
            }
            var p = {
                x: 1800,
                y: 900, 
            }
            var p2 = {
                longitude: 60,
                latitude: 60, 
            }
            updateMap();
        });
        
        
        
        var autoplay = false;
        var prev_step = displayingYear;
        var next_step = getNextAvailableYear(displayingYear);
        var refresh = 50;
        var cooldown = 2000;
        var step = cooldown / refresh;
        var intervalId = window.setInterval(function(){
            // speed = 1 change each 2 seconds
            
            if(!autoplay) return;

            if(displayingYear >= max_year){return}

            if(displayingYear >= next_step){
                prev_step = displayingYear
                updateMap();
            }

            
            next_step = getNextAvailableYear(displayingYear);
            var difference = next_step - prev_step;
            var sum = difference/step
            displayingYear = parseInt(displayingYear + (difference/step))
            console.log("Start")
            console.log(prev_step)
            console.log(displayingYear)
            console.log(next_step)
            console.log(difference)
            console.log(step)
            console.log(sum)
            
            
            


            displayingYear = Math.min(displayingYear + 10, max_year);
            if(displayingYear>=max_year) return;
            
        }, step);
    </script>
</html>
